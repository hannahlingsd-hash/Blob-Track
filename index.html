<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blob-Track â€” Motion Extract (Ghost + Stain)</title>
<style>
  :root { color-scheme: dark; --fg:#e9f9ef; --mut:#9fb3a7; --accent:#00f0c0; }
  html,body{height:100%;margin:0;background:#0b0f0d;font:14px/1.4 system-ui}
  #stage{position:fixed;inset:0;overflow:hidden}
  .layer{position:absolute;inset:0;display:block;width:100%;height:100%}
  #v{display:none}
  #gate{position:fixed;inset:0;display:grid;place-items:center;background:#000a}
  #gate .box{border:1px solid var(--accent);padding:14px 18px;border-radius:12px;color:var(--fg);background:#00150f}
  #ui{position:fixed;left:12px;bottom:12px;display:grid;gap:8px;
       background:#0c1512cc;padding:12px 12px;border-radius:12px;border:1px solid #21443a}
  #ui label{display:flex;align-items:center;gap:8px;color:var(--mut)}
  #ui input[type="range"]{width:160px}
  #ui input[type="color"]{width:32px;height:24px;border:none;background:transparent;padding:0}
  #ui .row{display:flex;gap:12px;flex-wrap:wrap}
  #ui .btn{border:1px solid #224; background:#10161a; color:#cfe; padding:6px 10px; border-radius:8px; cursor:pointer}
  #ui .btn:active{transform:translateY(1px)}
  #notice{position:fixed;right:12px;bottom:12px;color:#9fb3a7}
</style>
</head>
<body>

<div id="stage">
  <canvas id="stain" class="layer"></canvas>
  <canvas id="ghost" class="layer"></canvas>
</div>

<video id="v" playsinline muted></video>

<div id="gate"><div class="box">
  <b>Motion Extract</b><br/>Choose source:
  <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
    <button id="useCam" class="btn">Use Webcam</button>
    <label class="btn" for="file">Load Video</label>
    <input id="file" type="file" accept="video/*" style="display:none">
  </div>
  <div style="margin-top:8px;color:#9fb3a7">Tip: Large videos may run slower. 720p is plenty.</div>
</div></div>

<div id="ui" hidden>
  <div class="row">
    <label>Threshold <input id="th" type="range" min="5" max="120" value="35"></label>
    <label>Sample step <input id="step" type="range" min="2" max="12" value="5"></label>
    <label>Point size <input id="ps" type="range" min="1" max="8" value="3"></label>
  </div>
  <div class="row">
    <label>Ghost decay <input id="gd" type="range" min="0" max="40" value="5"></label>
    <label>Stain decay <input id="sd" type="range" min="0" max="30" value="3"></label>
  </div>
  <div class="row">
    <label>Ghost color <input id="gc" type="color" value="#00ffb4"></label>
    <label>Stain color <input id="sc" type="color" value="#ff8c00"></label>
  </div>
  <div class="row">
    <button id="toggleGhost" class="btn">Hide Ghost</button>
    <button id="toggleStain" class="btn">Hide Stain</button>
    <button id="saveFrame" class="btn">Save PNG</button>
  </div>
</div>

<div id="notice"></div>

<script>
(function () {
  const v = document.getElementById('v');
  const stain = document.getElementById('stain');
  const ghost = document.getElementById('ghost');
  const sctx = stain.getContext('2d');
  const gctx = ghost.getContext('2d');

  const gate = document.getElementById('gate');
  const ui = document.getElementById('ui');
  const notice = document.getElementById('notice');

  // UI elements
  const thEl = document.getElementById('th');
  const stepEl = document.getElementById('step');
  const psEl = document.getElementById('ps');
  const gdEl = document.getElementById('gd');
  const sdEl = document.getElementById('sd');
  const gcEl = document.getElementById('gc');
  const scEl = document.getElementById('sc');

  let showGhost = true, showStain = true;

  document.getElementById('toggleGhost').onclick = e=>{
    showGhost = !showGhost;
    e.target.textContent = showGhost ? 'Hide Ghost' : 'Show Ghost';
    ghost.style.display = showGhost ? 'block' : 'none';
  };
  document.getElementById('toggleStain').onclick = e=>{
    showStain = !showStain;
    e.target.textContent = showStain ? 'Hide Stain' : 'Show Stain';
    stain.style.display = showStain ? 'block' : 'none';
  };
  document.getElementById('saveFrame').onclick = ()=>{
    // composite both into a temp canvas and download
    const t = document.createElement('canvas');
    t.width = ghost.width; t.height = ghost.height;
    const tctx = t.getContext('2d');
    if (showStain) tctx.drawImage(stain,0,0);
    if (showGhost) tctx.drawImage(ghost,0,0);
    const a = document.createElement('a');
    a.download = 'blob-track.png';
    a.href = t.toDataURL('image/png');
    a.click();
  };

  // Gate controls
  document.getElementById('useCam').onclick = async ()=>{
    try{
      const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      v.srcObject = stream; await v.play(); start();
    }catch(err){ alert('Camera blocked. Load a video instead.'); }
  };
  document.getElementById('file').onchange = (e)=>{
    const f = e.target.files[0]; if(!f) return;
    v.srcObject = null;
    v.src = URL.createObjectURL(f);
    v.onloadedmetadata = async()=>{ await v.play(); start(); };
  };

  // --- Core ---
  let w=0,h=0, off, octx, prev;
  function resize() {
    const vw = v.videoWidth || 640;
    const vh = v.videoHeight || 480;
    const scale = Math.min(window.innerWidth/vw, window.innerHeight/vh);
    w = Math.round(vw*scale); h = Math.round(vh*scale);
    [stain, ghost].forEach(c=>{ c.width=w; c.height=h; });
    off = document.createElement('canvas'); off.width=w; off.height=h;
    octx = off.getContext('2d');
  }
  window.addEventListener('resize', ()=>{ if(v.readyState>=2) resize(); });

  function start(){
    gate.hidden = true; ui.hidden = false;
    resize();
    sctx.clearRect(0,0,w,h);
    gctx.clearRect(0,0,w,h);
    prev = null;
    requestAnimationFrame(tick);
  }

  function rgbaFromHex(hex, a=1){
    const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    const r=parseInt(m[1],16), g=parseInt(m[2],16), b=parseInt(m[3],16);
    return `rgba(${r},${g},${b},${a})`;
  }

  function tick(){
    if(v.readyState>=2){
      // draw current frame to offscreen
      octx.drawImage(v,0,0,w,h);
      const img = octx.getImageData(0,0,w,h);
      const data = img.data;

      // previous frame
      if(prev && prev.width===w && prev.height===h){
        const p = prev.data;

        // decay passes (independent)
        // ghost decay reduces alpha
        const gDecay = (Number(gdEl.value)||0)/100; // 0..0.4
        if (gDecay>0){
          gctx.globalCompositeOperation='destination-out';
          gctx.fillStyle = `rgba(0,0,0,${gDecay})`;
          gctx.fillRect(0,0,w,h);
          gctx.globalCompositeOperation='source-over';
        }
        // stain decay
        const sDecay = (Number(sdEl.value)||0)/100; // 0..0.3
        if (sDecay>0){
          sctx.globalCompositeOperation='destination-out';
          sctx.fillStyle = `rgba(0,0,0,${sDecay})`;
          sctx.fillRect(0,0,w,h);
          sctx.globalCompositeOperation='source-over';
        }

        // settings
        const T = Number(thEl.value)||35;          // threshold 5..120
        const STEP = Number(stepEl.value)||5;      // sampling step
        const PS = Number(psEl.value)||3;          // point size
        const ghostColor = rgbaFromHex(gcEl.value, 1);
        const stainColor = rgbaFromHex(scEl.value, 0.18); // subtle

        // draw loop (sampled grid)
        gctx.fillStyle = ghostColor;
        sctx.fillStyle = stainColor;

        for(let y=0; y<h; y+=STEP){
          for(let x=0; x<w; x+=STEP){
            const i = ((y*w)+x)*4;
            // luminance diff
            const r = data[i], g = data[i+1], b = data[i+2];
            const rp= p[i],   gp= p[i+1],   bp= p[i+2];
            const cur = 0.299*r + 0.587*g + 0.114*b;
            const old = 0.299*rp + 0.587*gp + 0.114*bp;
            const diff = Math.abs(cur - old);

            if (diff > T){
              // ghost = instantaneous motion marker
              if (showGhost){
                gctx.fillRect(x, y, PS, PS);
              }
              // stain = accumulative paint
              if (showStain){
                sctx.fillRect(x, y, PS, PS);
              }
            }
          }
        }
      }
      prev = img; // keep a copy
    }
    requestAnimationFrame(tick);
  }

  // small helper: show fps-ish info
  let last = performance.now(), frames=0;
  function ping(){
    frames++;
    const now = performance.now();
    if (now-last>1000){
      notice.textContent = frames+' fps';
      frames=0; last=now;
    }
    requestAnimationFrame(ping);
  }
  ping();

})();
</script>
</body>
</html>
